[[_TOC_]]

# GHC 9.4.x Migration Guide


This guide summarises the changes you may need to make to your code to migrate from GHC 9.2 to GHC 9.4. This guide complements the GHC 9.4.x release notes which should be consulted as well.

---

## Compiler changes


---

## Library changes

### `base-4.17`

#### Word64/Int64 use Word64#/Int64#

Before 9.4, `Int64/Word64` were wrappers for `Int#/Word#` on 64-bit architectures and for `Int64#/Word64#` on 32-bit architectures. Now the latter are always used (`Int64#/Word64#`). Users of the unboxed values must use `Int64#/Word64#` primops on every architecture.

### `ghc-prim-0.9`

#### reallyUnsafePtrEquality#

`GHC.Exts.reallyUnsafePtrEquality#` is now levity-polymorphic and heterogeneous, with type:

```haskell
reallyUnsafePtrEquality#
  :: forall {l :: Levity} {k :: Levity}
            (a :: TYPE ('BoxedRep l))
            (b :: TYPE ('BoxedRep k))
  . a -> b -> Int#
```

This means that it is no longer necessary to use `unsafeCoerce#` when using `reallyUnsafePtrEquality#` on values of different types, or whose types are unlifted, such as `Array#`, `ByteArray#`, `SmallArray#`. In fact, it is no longer possible to use `unsafeCoerce#` in this way, as GHC doesn't support unsaturated levity-polymorphic primops. This means that code such as

```haskell
hetPtrEq :: a -> b -> Bool
hetPtrEq a b = isTrue# (unsafeCoerce# reallyUnsafePtrEquality# a b)
```

will no longer typecheck. To fix this, simply remove the call to `unsafeCoerce#`:

```haskell
hetPtrEq :: a -> b -> Bool
hetPtrEq a b = isTrue# (reallyUnsafePtrEquality# a b)
```

#### magicDict

`magicDict` has been renamed to `withDict` and is now defined in `GHC.Magic.Dict` instead of `GHC.Prim`. Its arguments have been reordered; `withDict` now has the type:

```haskell
withDict :: forall {rr :: RuntimeRep} st dt (r :: TYPE rr). st -> (dt => r) -> r
```

#### Pointer equality primops

The following functions have been moved from `GHC.Prim` to `GHC.Exts`:
  - `sameMutableArray#`, `sameSmallMutableArray#`, `sameMutableByteArray#`
     and `sameMutableArrayArray#`,
  - `sameMutVar#`, `sameTVar#` and`sameMVar#`,
  - `sameIOPort#`,
  - `eqStableName#`.

Code that imported these functions from `GHC.Prim` will need to be modified to import them from `GHC.Exts` instead.